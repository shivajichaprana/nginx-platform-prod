name: Production Canary Deployment

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ECR image tag to deploy (e.g., abc1234 or v1.2.3)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::975050061334:role/github-actions-nginx-platform-prod
          aws-region: us-east-1

      - name: Verify image exists in ECR
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"
          ECR_REPO="975050061334.dkr.ecr.us-east-1.amazonaws.com/nginx-demo"
          
          echo "Verifying image: $ECR_REPO:$IMAGE_TAG"
          aws ecr describe-images \
            --repository-name nginx-demo \
            --image-ids imageTag=$IMAGE_TAG \
            --region us-east-1 || {
              echo "ERROR: Image tag $IMAGE_TAG not found in ECR"
              exit 1
            }
          
          echo "IMAGE_URI=$ECR_REPO:$IMAGE_TAG" >> $GITHUB_ENV

      - name: Render ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def-prod.json
          container-name: nginx
          image: ${{ env.IMAGE_URI }}

      - name: Deploy to GREEN target group (0% traffic)
        run: |
          GREEN_TG=$(aws elbv2 describe-target-groups \
            --names nginx-fargate-demo-prod-green \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text)
          
          # Register new task definition
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://${{ steps.task-def.outputs.task-definition }} \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "Registered task definition: $TASK_DEF_ARN"
          echo "GREEN_TG=$GREEN_TG" >> $GITHUB_ENV
          
          # Create new ECS service for green deployment
          SERVICE_EXISTS=$(aws ecs describe-services \
            --cluster nginx-fargate-demo-cluster \
            --services nginx-fargate-demo-prod-green \
            --query 'services[0].status' \
            --output text 2>/dev/null || echo "MISSING")
          
          if [ "$SERVICE_EXISTS" = "MISSING" ] || [ "$SERVICE_EXISTS" = "INACTIVE" ]; then
            echo "Creating new GREEN service..."
            aws ecs create-service \
              --cluster nginx-fargate-demo-cluster \
              --service-name nginx-fargate-demo-prod-green \
              --task-definition $TASK_DEF_ARN \
              --desired-count 2 \
              --launch-type FARGATE \
              --network-configuration "awsvpcConfiguration={subnets=[subnet-03702167be15c0f4b,subnet-0e0e6b45ecdef583d],securityGroups=[sg-0e0de858f860e2b8d],assignPublicIp=DISABLED}" \
              --load-balancers targetGroupArn=$GREEN_TG,containerName=nginx,containerPort=80 \
              --health-check-grace-period-seconds 60 \
              --deployment-configuration "maximumPercent=200,minimumHealthyPercent=100,deploymentCircuitBreaker={enable=true,rollback=true}"
          else
            echo "Updating existing GREEN service..."
            aws ecs update-service \
              --cluster nginx-fargate-demo-cluster \
              --service nginx-fargate-demo-prod-green \
              --task-definition $TASK_DEF_ARN \
              --desired-count 2 \
              --force-new-deployment
          fi
          
          echo "Waiting for GREEN service stability..."
          aws ecs wait services-stable \
            --cluster nginx-fargate-demo-cluster \
            --services nginx-fargate-demo-prod-green
          
          echo "✅ Deployment complete to GREEN target group"
          echo "⚠️  GREEN is receiving 0% traffic"
          echo "⚠️  Use 'Traffic Shift' workflow to gradually shift traffic from BLUE to GREEN"

      - name: Get CloudWatch logs
        if: always()
        run: |
          echo "Recent logs from production:"
          aws logs tail /ecs/nginx-fargate-demo-prod --since 5m --format short || true
